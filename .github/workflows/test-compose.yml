# .github/workflows/test-compose.yml

name: Test Docker Compose

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ðŸ‘‡ ADD THIS NEW DEBUGGING STEP ðŸ‘‡
      - name: Debug Environment Variables
        env:
          CONTAINERPORT_API: ${{ secrets.CONTAINERPORT_API }}
        run: |
          echo "Debug Step:"
          echo "The value for CONTAINERPORT_API is: '$CONTAINERPORT_API'"
          if [ -z "$CONTAINERPORT_API" ]; then
            echo "ERROR: CONTAINERPORT_API is empty!"
            exit 1
          fi

      - name: Run Docker Compose
        # This 'env' block makes the GitHub Secrets available as
        # environment variables for the 'docker compose' command.
        env:
          DISABLE_LOG_FORWARDING: ${{ secrets.DISABLE_LOG_FORWARDING }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          CONTAINERPORT_API: ${{ secrets.CONTAINERPORT_API }}
          FRONTEND_HOST_PORT: ${{ secrets.FRONTEND_HOST_PORT }}
          CONTAINERPORT_MCP_IMAP: ${{ secrets.CONTAINERPORT_MCP_IMAP }}
          CONTAINERPORT_QDRANT: ${{ secrets.CONTAINERPORT_QDRANT }}
          AGENTLOGGER_ENABLE_ANONIMIZER: ${{ secrets.AGENTLOGGER_ENABLE_ANONIMIZER }}
          EMBEDDING_VECTOR_SIZE: ${{ secrets.EMBEDDING_VECTOR_SIZE }}
          EMBEDDING_OPENAI_MODEL_NAME: ${{ secrets.EMBEDDING_OPENAI_MODEL_NAME }}
          EMBEDDING_OPENAI_API_KEY: ${{ secrets.EMBEDDING_OPENAI_API_KEY }}
          EMBEDDING_VOYAGE_MODEL: ${{ secrets.EMBEDDING_VOYAGE_MODEL }}
          EMBEDDING_VOYAGE_API_KEY: ${{ secrets.EMBEDDING_VOYAGE_API_KEY }}
          # Add every other secret your compose file needs here
          # ANOTHER_VARIABLE: ${{ secrets.ANOTHER_VARIABLE }}
          # DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: docker compose up -d --build

      - name: Wait for services
        run: sleep 10

      - name: Check running containers
        run: docker compose ps